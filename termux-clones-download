#!/usr/bin/env bash
# One-shot: download & install Codex.0..Codex.8 from GitHub releases
# No loop, no Termux:Boot, no workspace JSON changes.
set -euo pipefail

# Config: base release path and numeric range (inclusive)
BASE_URL="https://github.com/Fizlyss/cloud-phone/releases/download/er"
FROM=0
TO=8

# Paths
LOG_DIR="$HOME/.local/share/cryptic_codex_one_shot"
APK_DIR="$HOME/apks"
TMP_DIR="$HOME/.tmp_cryptic"
mkdir -p "$LOG_DIR" "$APK_DIR" "$TMP_DIR"
LOG_FILE="$LOG_DIR/run.log"

timestamp(){ date -u +"%Y-%m-%dT%H:%M:%SZ"; }
log(){ printf "[%s] %s\n" "$(timestamp)" "$*" | tee -a "$LOG_FILE"; }
die(){ log "FATAL: $*"; exit 1; }

# Simple http fetch with retries
http_fetch_to(){
  local url="$1" dest="$2" tmp="${dest}.part"
  rm -f "$tmp"
  if curl -fsSL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$tmp" "$url" &>>"$LOG_FILE"; then
    mv -f "$tmp" "$dest"
    return 0
  else
    rm -f "$tmp"
    return 1
  fi
}

# Best-effort APK installer (tries multiple methods)
pm_install_apk(){
  local apk="$1"
  log "Attempting install: $(basename "$apk")"
  # try pm with typical flags (may require root)
  if /system/bin/pm install -r -d --user 0 "$apk" >>"$LOG_FILE" 2>&1; then
    return 0
  fi
  # fallback: cmd package
  if command -v cmd >/dev/null 2>&1 && cmd package install -r "$apk" >>"$LOG_FILE" 2>&1; then
    return 0
  fi
  # final fallback
  if /system/bin/pm install "$apk" >>"$LOG_FILE" 2>&1; then
    return 0
  fi
  return 1
}

main(){
  log "One-shot Codex downloader/installer starting (range: $FROM..$TO)."

  # check for required command
  command -v curl >/dev/null 2>&1 || die "curl is required. Install with apt."

  # Download loop 0..8
  for i in $(seq "$FROM" "$TO"); do
    name="Codex.${i}.apk"
    url="${BASE_URL}/${name}"
    dest="${APK_DIR}/${name}"
    log "Fetching $name from $url"
    if http_fetch_to "$url" "$dest"; then
      log "Downloaded $name -> $dest"
    else
      log "WARN: Failed to download $name (skipping)"
      rm -f "$dest"
    fi
  done

  # Install any downloaded APKs
  shopt -s nullglob
  local ok=0 total=0
  for apk in "$APK_DIR"/*.apk; do
    total=$((total+1))
    if pm_install_apk "$apk"; then
      log "Installed: $(basename "$apk")"
      rm -f "$apk"
      ok=$((ok+1))
    else
      log "WARN: Install failed for $(basename "$apk") (left in $APK_DIR)"
    fi
  done

  log "Finished: installed $ok/$total APKs. Exiting."
}

main "$@"
