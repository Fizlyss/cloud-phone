#!/usr/bin/env bash
# Oneâ€‘Shot Clones Downloader â€” Enhanced UI
# Colorized Termux menu + in-place refreshed status panel + nicer layout

set -eo pipefail

# --------------- Configuration ---------------
BASE_URL="https://github.com/Fizlyss/cloud-phone/releases/download/er"
APK_NAMES=( "Codex.0.apk" "Codex.1.apk" "Codex.2.apk" "Codex.3.apk" "Codex.4.apk" "Codex.5.apk" "Codex.6.apk" "Codex.7.apk" )

# --------------- Paths & State ---------------
LOG_DIR="$HOME/.local/share/cryptic_termux"
APK_DIR="$HOME/apks"
TMP_DIR="$HOME/.tmp_cryptic"
STATE_DIR="$HOME/.cryptic_state"
LOG_FILE="$LOG_DIR/run.log"

mkdir -p "$LOG_DIR" "$APK_DIR" "$TMP_DIR" "$STATE_DIR"

# --------------- Colors (Termux/ANSI) ---------------
RED="[31m"
GREEN="[32m"
YELLOW="[33m"
BLUE="[34m"
MAGENTA="[35m"
CYAN="[36m"
BOLD="[1m"
RESET="[0m"

# --------------- Utilities ---------------
timestamp() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }
log() { mkdir -p "$LOG_DIR"; printf "[%s] %s
" "$(timestamp)" "$*" | tee -a "$LOG_FILE"; }
die() { printf "[%s] FATAL: %s
" "$(timestamp)" "$*" | tee -a "$LOG_FILE" >&2; exit 1; }

http_fetch_to() {
  # $1 url, $2 dest
  local url="$1" dest="$2" tmp="${dest}.part"
  rm -f "$tmp"
  if curl -fsSL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$tmp" "$url" 2>>"$LOG_FILE"; then
    mv -f "$tmp" "$dest"
    return 0
  else
    rm -f "$tmp"
    return 1
  fi
}

ensure_packages() {
  log "Ensuring basic packages (curl, jq, coreutils)..."
  apt update -y >>"$LOG_FILE" 2>&1 || true
  apt install -y curl coreutils jq busybox procps unzip >>"$LOG_FILE" 2>&1 || true
}

ensure_storage() {
  if command -v termux-setup-storage >/dev/null 2>&1; then
    log "Ensuring Termux storage access (if applicable)..."
    termux-setup-storage >/dev/null 2>&1 || true
  fi
  mkdir -p "$APK_DIR" "$TMP_DIR" "$LOG_DIR"
}

pm_install_apk() {
  local apk="$1"
  log "Attempting install/update: $apk"
  if /system/bin/pm install -r -d --user 0 "$apk" >>"$LOG_FILE" 2>&1; then return 0; fi
  if command -v cmd >/dev/null 2>&1 && cmd package install -r "$apk" >>"$LOG_FILE" 2>&1; then return 0; fi
  if /system/bin/pm install "$apk" >>"$LOG_FILE" 2>&1; then return 0; fi
  return 1
}

# --------------- UI / Enhanced Panel ---------------
HEADER_HEIGHT=9  # number of lines before the table starts

# initialize status array
declare -a STATUS
for i in "${!APK_NAMES[@]}"; do
  STATUS["$i"]="${YELLOW}Pending${RESET}"
done

render_header() {
  clear
  cat <<'EOF'
${CYAN}${BOLD}  ____        _   _           _                 _           
 |  _ \ _   _| |_| |__   ___ | |__   __ _  ___| |__  _   _ 
 | |_) | | | | __| '_ \ / _ \| '_ \ / _` |/ __| '_ \| | | |
 |  __/| |_| | |_| | | | (_) | |_) | (_| | (__| | | | |_| |
 |_|    \__, |\__|_| |_|\___/|_.__/ \__,_|\___|_| |_|\__, |
        |___/                                       |___/ 
${RESET}
EOF
  printf "   %s%s%s
" "${GREEN}" "Auto download Clones" "${RESET}"
  printf "   %s%s%s

" "${YELLOW}" "v.1 (one-shot mode)" "${RESET}"
  printf " %s%-30s %s %s
" "${CYAN}" "Package Operation Status" "${RESET}" ""
  printf " %s-----------------------------------------------%s

" "${CYAN}" "${RESET}"
  printf " ${BOLD}%-30s | %-15s${RESET}
" "Package" "Status"
  printf " %s-----------------------------------------------%s
" "${CYAN}" "${RESET}"
}

render_table() {
  # redraw header + table
  render_header
  for idx in "${!APK_NAMES[@]}"; do
    local name="${APK_NAMES[$idx]}"
    printf " %-30s | %s
" "$name" "${STATUS[$idx]}"
  done
  printf "
"
}

set_status() {
  local idx="$1" val="$2"
  STATUS[$idx]="$val"
  render_table
}

# --------------- One-Shot Task (improved visuals) ---------------
task_one_shot() {
  log "Starting enhanced one-shot APK download & update..."
  ensure_packages
  ensure_storage

  local ok=0 total=${#APK_NAMES[@]}
  render_table

  local start_ts=$(date +%s)
  for idx in "${!APK_NAMES[@]}"; do
    local name="${APK_NAMES[$idx]}"
    set_status "$idx" "${YELLOW}Downloading...${RESET}"
    local url="$BASE_URL/$name" dest="$APK_DIR/$name"

    if http_fetch_to "$url" "$dest"; then
      set_status "$idx" "${CYAN}Downloaded${RESET}"
      set_status "$idx" "${CYAN}Installing...${RESET}"
      if pm_install_apk "$dest"; then
        set_status "$idx" "${GREEN}Installed/Updated${RESET}"
        rm -f "$dest"
        ok=$((ok+1))
      else
        set_status "$idx" "${RED}Install Failed${RESET}"
      fi
    else
      set_status "$idx" "${RED}Download Failed${RESET}"
    fi

    # show progress summary
    local elapsed=$(( $(date +%s) - start_ts ))
    printf "
 %sProgress:%s %d/%d    Elapsed: %s sec
" "${MAGENTA}" "${RESET}" "$ok" "$total" "$elapsed"
  done

  set_status 0 "" >/dev/null 2>&1 || true
  printf "
"
  log "Finished one-shot: $ok/$total installed/updated."
  read -rp "Press ENTER to return to menuâ€¦" _
}

# --------------- Menu ---------------
print_menu() {
  clear
  printf "%s%s Oneâ€‘Shot Clones Downloader %s

" "${BOLD}${CYAN}" "[menu]" "${RESET}"
  printf " %s1) Oneâ€‘Shot Mode (download & update) %s
" "${GREEN}" "${RESET}"
  printf " %s2) Exit                                 %s

" "${RED}" "${RESET}"
  read -rp "Select an option [1-2]: " choice
}

# --------------- Main Loop ---------------
while true; do
  print_menu
  case "$choice" in
    1) task_one_shot ;;
    2) echo -e "${CYAN}Exiting. Goodbye!${RESET}"; exit 0 ;;
    *) echo -e "${RED}Invalid choice. Try again.${RESET}"; sleep 1 ;;
  esac
done

