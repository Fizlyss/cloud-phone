
#!/bin/bash
# Codex Control Panel - Termux/Android Shell
# Works on UGPhone, VMOS, Emulators
# Author: ChatGPT

CONFIG="$HOME/.codex_config"
LOG_FILE="$HOME/.codex_log"

# Defaults
BASE_URL="https://github.com/Fizlyss/cloud-phone/releases/download/er"
FROM=0
TO=8
SKIP=""
USE_TSU=false

# Load config if exists
if [ -f "$CONFIG" ]; then
    source "$CONFIG"
fi

# Helpers
log() {
    echo -e "[$(date '+%H:%M:%S')] $*" | tee -a "$LOG_FILE"
}
save_config() {
    cat > "$CONFIG" <<EOF
BASE_URL="$BASE_URL"
FROM=$FROM
TO=$TO
SKIP="$SKIP"
USE_TSU=$USE_TSU
EOF
    log "‚úÖ Config saved."
}
pause() {
    echo -ne "\nPress enter to continue... "
    read _
}

# Tasks
task_download() {
    log "üì• Downloading Codex APKs ($FROM ‚Üí $TO)..."
    for i in $(seq $FROM $TO); do
        if [[ "$SKIP" =~ (^| )$i($| ) ]]; then
            log "‚è≠Ô∏è Skipping Codex.$i.apk"
            continue
        fi
        url="$BASE_URL/Codex.$i.apk"
        file="Codex.$i.apk"
        log "‚¨áÔ∏è  $file"
        curl -fsSL "$url" -o "$file" || log "‚ùå Failed to download $file"
    done
    log "‚úÖ Download finished."
    pause
}

task_install() {
    log "üì≤ Installing Codex APKs..."
    for file in Codex.*.apk; do
        [ -f "$file" ] || continue
        if $USE_TSU && command -v tsu >/dev/null 2>&1; then
            tsu -c "pm install -r '$file'" >/dev/null 2>&1 && \
            log "‚úÖ Installed $file" || log "‚ùå Failed $file"
        else
            pm install -r "$file" >/dev/null 2>&1 && \
            log "‚úÖ Installed $file" || log "‚ùå Failed $file"
        fi
    done
    pause
}

task_status() {
    log "üìä Checking Codex APK status..."
    for i in $(seq $FROM $TO); do
        pkg="com.example.codex$i"
        if pm list packages | grep -q "$pkg"; then
            echo "[$i] ‚úÖ Codex.$i installed"
        else
            echo "[$i] ‚ùå Codex.$i missing"
        fi
    done
    pause
}

task_logs() {
    less +G "$LOG_FILE"
}

task_configure() {
    echo "Current source: $BASE_URL"
    echo "Enter new BASE_URL (or leave empty to keep):"
    read newurl
    [ -n "$newurl" ] && BASE_URL="$newurl"

    echo "Current range: $FROM - $TO"
    echo "Enter FROM index:"
    read newfrom
    echo "Enter TO index:"
    read newto
    FROM=${newfrom:-$FROM}
    TO=${newto:-$TO}

    echo "Enter SKIP list (e.g. '5 7') or leave empty:"
    read newskip
    [ -n "$newskip" ] && SKIP="$newskip"

    echo "Use tsu/root for install? (y/n)"
    read ans
    [[ "$ans" == "y" ]] && USE_TSU=true || USE_TSU=false

    save_config
    pause
}

# Menu
while true; do
    clear
    echo "==============================="
    echo "      üì± Codex Control Panel"
    echo "==============================="
    echo " Source: $BASE_URL"
    echo " Range:  $FROM ‚Üí $TO"
    echo " Skip:   $SKIP"
    echo " Root:   $USE_TSU"
    echo
    echo "1) Download Codex APKs"
    echo "2) Install Codex APKs"
    echo "3) Status of Codex APKs"
    echo "4) View Logs"
    echo "5) Configure Settings"
    echo "6) Exit"
    echo
    echo -n "Choose an option: "
    read choice
    case $choice in
        1) task_download ;;
        2) task_install ;;
        3) task_status ;;
        4) task_logs ;;
        5) task_configure ;;
        6) exit 0 ;;
        *) echo "Invalid option"; sleep 1 ;;
    esac
done
